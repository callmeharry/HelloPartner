<!--Author:Callmeharry Time:2014/8/30-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>任务</title>
<link href="/static/css/quest.css" rel="stylesheet" type="text/css" />
<link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/static/css/datepicker.css" rel="stylesheet" type="text/css" />
<script src="/static/js/quest.js">
</script>
<script src="/static/js/jquery-1.11.1.min.js">
</script>
<script src="/static/js/bootstrap.min.js">
</script>
<script src="/static/js/mustache.js">
</script>
<script src="/static/js/alert.js">
</script>
<script src="/static/js/bootstrap-datepicker.js">
</script>
</head>

<body onload="load()">
<div class="quest">
	<div class="new-quest">
		<div class="new-quest-button">
		<a onclick="show_new_quest_detail()" style="text-decoration:none; cursor:pointer"><span class="glyphicon glyphicon-plus"></span><span style="padding-left:5px">新任务</span></a>
		</div>
		<div class="new-quest-content" id="content">
			<form class="form-horizontal" role="form" method="POST" action="submittask/">
			<div class="form-group">
				 <label class="col-sm-2 control-label">任务名称：</label>
				<div class="col-sm-10">
				 <input type="text" name="new_quest_name" class="form-control" />
				 </div>
			</div>
			<div class="form-group">
				 <label class="col-sm-2 control-label">任务说明：</label>
				 <div class="col-md-10">
				 <textarea name="new_quest_description"  class="form-control" cols="80" rows="4"></textarea>
				 </div>
			</div>
			<div class="form-group">
				 <label class="col-sm-2 control-label">任务分配：<div id="add-singlequest-bar">
				 	<a onclick="add_singlequest()" style="cursor:pointer; text-decoration:none"><span class="glyphicon glyphicon-plus"></span><span style="padding-left:5px">添加分配</span></a>
				 </div></label>
				 <div id="singlequest-list" class="col-sm-10">
				 </div>
			</div>
			<div class="form-group">
				<label class="col-sm-2 control-label">任务时限：</label>
				 <div id="new-quest-time" class="col-sm-10">
				 <input type="text" class="span2" data-date-format="yyyy-mm-dd" id="dp1" name="begintime" readonly="readonly" >
					<label class="control-label">——</label>
					<input type="text" class="span2" data-date-format="yyyy-mm-dd" id="dp2" name="endtime" readonly="readonly" >
					<!--传个当前的日期-->
					<label style="visibility:hidden">{{current_date}}</label>
					<br />
					<span class="time-hint" id="time-hint">
					请选择正确的日期
					</span>
				 </div>
			</div>
				 <div class="form-group" style="text-align:center">
				 	<div class="col-sm-6">
						<button type="reset" class="btn btn-default" >重置</button>
					</div>
					<div class="col-sm-6">
						<!--下面的hidden的标签，value是最大个数，singlequest标号从0开始到value-->
						<input type="hidden" id="max-singlequest-num" name="max_singlequest_num" value="0"/>
						<button type="submit" class="btn btn-default" id="new-quest-submit" disabled="disabled" >提交</button>
					</div>
				</div>
			</form>
		</div>
	</div>
{% for quest,singlequests in tasksdir.items %}<!--stateid是任务的状态，有未开始（before-start）、进行中（doing）、已完成（end）三个值-->
	<div class="previous-quest-singlequest border-{{quest.state}}" id="previous-quest-{{quest.id}}">
		<div class="previous-quest-title">
			<div class="col-md-2">
				{{quest.begintime}}
			</div>
			<div class="previous-quest-name col-md-8"><b>{{quest.taskname}}</b>
			</div>
			<div class="col-md-2">
				<a name="qid" onclick="show_previous_quest_detail(this)" style="cursor:pointer; text-decoration:none">展开</a>
			</div>
		</div>
		<div class="previous-quest-detail" id="previous-quest-detail-qid">
			<div class="previous-quest-detail-description container">
			<label class="col-sm-2 control-label">说明：</label>
			<span class="col-sm-10">{{quest.explanation}}</span>
			</div>
			<div class="container previous-quest-detail-author">
			<label class="col-sm-2 control-label">发布人：</label>
			<span class="col-sm-10">{{quest.tasklauncher}}</span>
			</div>
			<div class="container previous-quest-detail-timelimit">
			<label class="col-sm-2 control-label">任务时限：</label>
			<span class="col-sm-10">{{quest.endtime}}}</span>
			</div>
			<div class="container">
			<label class="col-sm-2 control-label">细节：</label>
				<div class="col-sm-10">
					<div class="previous-quest-detail-singlequest-list">
						{% for singlequest,members in singlequests.items %}
						<div class="previous-quest-detail-singlequest" id="{{singlequest.id}}">
							<div class="previous-quest-detail-singlequest-content+state row">
								<div class="previous-quest-detail-singlequest-content col-sm-5">{{singlequest.decription}}
								</div>
								<!--这里的singlequest.stateid同上-->
								<div class="previous-quest-detail-singlequest-state col-sm-1 text-{{singlequest.state}}"><b>{{singlequest.state}}</b>
								</div>
							</div>
							<div>
								<label class="control-label">负责人：</label>
								<div class="previous-quest-detail-singlequest-staff container" id="previous-quest-detail-singlequest-staff-{{singlequest.id}}">
									{% for staff in members %}
									<div class="previous-quest-detail-singlequest-singlestaff row" id="{{staff.username}}-detail">
										<div class="previous-quest-detail-singlequest-singlestaff-name" style="float:left" id="{{staff.id}}-name">{{staff.username}}
										</div>
										<div class="previous-quest-detail-singlequest-singlestaff-state" style="float:right; padding-right:10px" id="{{staff.id}}-state">
										<!--下面的name是登陆的人的名字，这里的意思是，如果下面的员工的名字是登陆者的话，他可以设置他的工作完成-->
										{% ifequal staff.username name  %}
											<a style="text-decoration:none; cursor:pointer" title="点击完成该任务">
										{% endifequal %}
										{{staff.state}}
										{% ifequal staff.username name %}
											</a>
										{% endifequal %}
										</div>
									</div>
									{% endfor %}
								</div>
							</div>
						</div>
						{% endfor%}
					</div>
				</div>
			</div>
			{% ifequal quest.tasklauncher  name %}<!--只有发布者可以删除该任务-->
			<div class="previous-quest-delete container">
				<div class="col-sm-2">
				<a onclick="delete_previous_quest(this)" name="1" style="cursor:pointer; text-decoration:none"><span class="glyphicon glyphicon-minus"></span>删除</a>
				</div>				
			</div>
			{% endifequal %}
		</div>
	</div>
	{% endfor %}
</div>
<!--<script>标签里的{{num}}后台不要替换-->
<script id="new-quest-singlequest-tmpl" type="text/html">
<div class="singlequest" id="singlequest-{{num}}">
		<textarea class="form-control" cols="40" rows="4" placeholder="在这里输入单项任务的内容" name="singlequest_textarea_{{num}}"></textarea><br />
		<label class="control-label">分配给</label>
		<!--下面的staff是团队所有人的名字的一个数组-->
		{% for staff in staffs %}
		<input type="checkbox" name="singlequest_chechbox_{{num}}" value="{{staff}}">{{staff}}
		{% endfor %}
		<br /><a onclick="delete_singlequest(this)"  name= "{{num}}"style="text-decoration:none; cursor:pointer"><span class="glyphicon glyphicon-minus"></span><span style="padding-left:5px">删除</span></a>
</div>
</script>
<script>
$(function(){
	var t1 = 0;
	var t2 = 0;
$('#dp1').datepicker().on('changeDate',function(ev){var date = new Date();var time = date.getTime();if(ev.date.valueOf()>time)t1 = ev.date.valueOf();  else t1 = 0; if(t1 !=0 &&t2 !=0  && t1 <=t2){document.getElementById("time-hint").style.display = "none"; document.getElementById("new-quest-submit").disabled=false;}else{document.getElementById("time-hint").style.display = ""; document.getElementById("new-quest-submit").disabled=true;}});
$('#dp2').datepicker().on('changeDate',function(ev){var date = new Date();var time = date.getTime();if(ev.date.valueOf()>time)t2 = ev.date.valueOf();  else t2 = 0; if(t1 !=0 &&t2 !=0  && t1 <=t2){document.getElementById("time-hint").style.display = "none"; document.getElementById("new-quest-submit").disabled=false;}else{document.getElementById("time-hint").style.display = ""; document.getElementById("new-quest-submit").disabled=true;}});
});
</script>
</body>
</html>
